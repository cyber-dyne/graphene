<!--
Copyright (c) 2018, Cyber Dyne SRL. All rights reserved.
This code may only be used under the BSD style license found at https://github.com/cyber-dyne/graphene/License.txt
The complete set of authors may be found at https://github.com/cyber-dyne/graphene/Authors.txt
The complete set of contributors may be found at https://github.com/cyber-dyne/graphene/Contributors.txt
-->
<link rel="import" href="../../polymer/polymer.html"/>
<link rel="import" href="../lib/lodash.html"/>
<link rel="import" href="graphene-datastore-behavior.html"/>
<link rel="import" href="graphene-localize-behavior.html"/>
<link rel="import" href="graphene-rest-behavior.html"/>
<link rel="import" href="graphene-store-api.html"/>
<link rel="import" href="graphene-widgetlifecycle-behavior.html"/>

<script>
    // <![CDATA[
    ;(function (undefined) {
        'use strict'

        /** @polymerBehavior */
        Graphene.WidgetBehaviorImpl = {
            properties: {
                storeStatePath: {
                    type: String,
                },

                state: {
                    type: Object,
                    value: Lodash.stubObject,
                },
            },

            observers: [
                '_fireStepperStepLifecycleChangedEvent(enabled, valid, isAttached)',
            ],

            //// Lifecycle callbacks. //////////////////////////////////////

            //// Computers. ////////////////////////////////////////////////

            //// Observers. ////////////////////////////////////////////////

            _fireStepperStepLifecycleChangedEvent(enabled, valid, isAttached) {
                if (isAttached !== true) {
                    // We must be attached to fire the event.
                    return
                }

                const eventDetail = {
                    enabled: enabled,
                    valid:   valid,
                }

                this.fire('graphene-stepper-step-lifecycle-changed', eventDetail)
            },

            //// Listeners. ////////////////////////////////////////////////

            //// Public APIs. //////////////////////////////////////////////

            /*
            * EXAMPLE
            * this.mutate('todo.list.count', 99)
            * this.mutate({ 'books.items': [], 'movies[0]': {} })
            */
            mutate(...args) {
                if (args.length < 1 || args.length > 2) {
                    throw 'Invalid arguments.'
                }

                const { mutate } = this.store
                const { storeStatePath } = this

                const absMutations = {}
                const mutations = args.length === 1
                    ? args[0]
                    : {
                        [args[0]]: args[1],
                    }

                if (Lodash.isEmpty(mutations)) {
                    return
                }

                for (const path in mutations) {
                    absMutations[`${storeStatePath}.${path}`] = mutations[path]
                }

                mutate(() => absMutations)
            },

            //// Internal APIs. ////////////////////////////////////////////
        }

        /** @polymerBehavior */
        Graphene.WidgetBehavior = [
            Graphene.DatastoreBehavior,
            Graphene.LocalizeBehavior,
            Graphene.RestBehavior,
            Graphene.WidgetLifecycleBehavior,
            Graphene.WidgetBehaviorImpl,
        ]
    })()
    // ]]>
</script>
