<!--
Copyright (c) 2018, Cyber Dyne SRL. All rights reserved.
This code may only be used under the BSD style license found at https://github.com/cyber-dyne/graphene/License.txt
The complete set of authors may be found at https://github.com/cyber-dyne/graphene/Authors.txt
The complete set of contributors may be found at https://github.com/cyber-dyne/graphene/Contributors.txt
-->
<link rel="import" href="../../iron-list/iron-list.html"/>
<link rel="import" href="../../paper-dropdown-menu/paper-dropdown-menu.html"/>
<link rel="import" href="../../paper-input/paper-input.html"/>
<link rel="import" href="../../polymer/polymer.html"/>
<link rel="import" href="../core/graphene-localize-behavior.html"/>
<link rel="import" href="../lib/lodash.html"/>
<link rel="import" href="graphene-dropdown-menu-behavior.html"/>
<link rel="import" href="graphene-icons.html"/>
<link rel="import" href="graphene-style.html"/>

<dom-module id="graphene-dropdown-menu">
    <template>
        <style include="graphene-style"></style>

        <style>
            host {
                display: block;
            }

            #List ::slotted(template ~ *),      /* Shadow DOM */
            #List ::slotted(* > template ~ *) { /* Shady DOM  */
                display: inline-block;  /* For vertical-align. */

                padding: 0 var(--graphene-gutter-s);

                line-height:    2.2em;
                letter-spacing: -0.02em;
                font-weight:    400;

                vertical-align: middle;
                overflow:       hidden;
                text-overflow:  ellipsis;

            }

            #List ::slotted(template ~ [selected]),      /* Shadow DOM */
            #List ::slotted(* > template ~ [selected]) { /* Shady DOM  */
                color:            var(--graphene-dropdown-menu-selected-item-color);
                background-color: var(--graphene-dropdown-menu-selected-item-background-color);
            }

            #List ::slotted(template ~ *:focus),      /* Shadow DOM */
            #List ::slotted(* > template ~ *:focus) { /* Shady DOM  */
                outline: none;
                background-color: var(--graphene-dropdown-menu-focus-color);
            }

            #List ::slotted(template ~ *:hover),      /* Shadow DOM */
            #List ::slotted(* > template ~ *:hover) { /* Shady DOM  */
                background-color: var(--graphene-dropdown-menu-focus-color);
            }

            paper-dropdown-menu {
                width: 100%;
                --paper-input-container-underline: {
                    border-bottom: 1px solid var(--paper-grey-200);
                };
                --paper-dropdown-menu-button: {
                    /*
                    * Fixes the
                    * <span role="button"></span>
                    * pushing down the <paper-menu-button> in Shady DOM.
                    */
                    float: left;
                    width: 100%;
                };
            }

            iron-list {
                width:  var(--graphene-dropdown-menu-width,  400px);
                height: var(--graphene-dropdown-menu-height, 400px);

                background-color: var(--graphene-dropdown-menu-background-color);

                cursor: pointer;

                --iron-list-items-container: {
                    font-size: 0.9em;

                    color:            var(--graphene-dropdown-menu-color);
                    background-color: var(--graphene-dropdown-menu-background-color);
                };
            }

            #Filter {
                /* <paper-input> */
                width: var(--graphene-dropdown-menu-width, 400px);
                padding: var(--graphene-gutter-xs) var(--graphene-gutter-s);
                background-color: var(--graphene-dropdown-menu-background-color);

                --paper-input-container-input: {
                    padding: 5px 0;
                };
                --paper-input-container-underline: {
                    border-bottom: 1px solid var(--paper-grey-200);
                };
                --paper-input-container-focus-color: var(--graphene-dropdown-menu-focus-color);
            }

            #Filter iron-icon[prefix] {
                --iron-icon: {
                    margin-right: var(--graphene-gutter-xs);
                    color:        var(--paper-grey-500);
                };
            }
        </style>

        <paper-dropdown-menu id="Menu"
                             label="[[ label ]]"
                             vertical-align="[[ valign ]]"
                             horizontal-align="[[ halign ]]"
                             disabled="[[ disabled ]]"
                             required="[[ required ]]"
                             invalid="{{ invalid }}"
                             on-selected-item-changed="_stopEvent">

            <div id="Content" class="dropdown-content">
                <paper-input id="Filter"
                             value="{{ search }}"
                             type="search"
                             no-label-float
                             hidden$="[[ ! filter ]]">
                    <iron-icon icon="icons:search" prefix></iron-icon>
                </paper-input>

                <slot id="HeaderSlot" name="header"></slot>

                <!--
                | iron-list doesn't support selecting an item through the binding
                | but requires an imperative call of the method .selectItem().
                -->
                <iron-list id="List"
                           items="{{ filteredItems }}"
                           selection-enabled
                           multi-selection="[[ multi ]]"
                           on-selected-item-changed="_stopEvent"
                           on-selected-items-changed="_selectedItemsChanged">
                    <slot id="ContentSlot"></slot>
                </iron-list>

                <slot id="FooterSlot" name="footer"></slot>
            </div>

        </paper-dropdown-menu>
    </template>

    <script>
        // <![CDATA[
        ;(function (undefined) {
            'use strict'

            Polymer({
                is: 'graphene-dropdown-menu',

                behaviors: [
                    Graphene.DropdownMenuBehavior,
                    Graphene.LocalizeBehavior,
                ],

                properties: {
                    items: {
                        type: Array,
                    },

                    itemAs: {
                        type: String,
                        value: 'item',
                    },

                    selectedItem: {
                        type: Object,
                        notify: true,
                    },

                    selectedItems: {
                        type: Object,
                        notify: true,
                    },

                    disabled: {
                        type: Boolean,
                        value: false,
                        reflectToAttribute: true,
                    },

                    required: {
                        type: Boolean,
                        value: false,
                        reflectToAttribute: true,
                    },

                    invalid: {
                        type: Boolean,
                        value: false,
                        notify: true,
                        reflectToAttribute: true,
                    },

                    label: {
                        type: String,
                    },

                    titleFormatter: {
                        type: Function,
                        value() {
                            function titleFormatter(selected) {
                                const title = Lodash.isArray(selected)
                                    ? selected.map(it => it.name).join(', ')
                                    : selected.name

                                return title
                            }

                            return titleFormatter
                        },
                    },

                    multi: {
                        type: Boolean,
                        value: false,
                        reflectToAttribute: true,
                    },

                    manualSelect: {
                        type: Boolean,
                        value: false,
                    },

                    filter: {
                        type: Boolean,
                        value: false,
                    },

                    filterFields: {
                        type: Array,
                        value() {
                            return [ 'name' ]
                        },
                    },

                    filteredItems: {
                        type: Array,
                    },

                    search: {
                        type: String,
                    },

                    maxHeight: {
                        type: Number,
                    },

                    itemHeight: {
                        type: Number,
                    },

                    valign: {
                        type: String,
                        value: 'top',
                    },

                    halign: {
                        type: String,
                        value: 'left',
                    },
                },

                observers: [
                    '_setFilteredItems(items, search)',
                    '_setItemsSize(items, itemHeight, maxHeight)',

                    '_selectAuto(items, filteredItems)',

                    '_select(filteredItems, selectedItem)',
                    '_select(filteredItems, selectedItems)',

                    '_setTitle(selectedItem, multi, titleFormatter)',
                    '_setTitle(selectedItems, multi, titleFormatter)',
                    '_setTitle(selectedItems.length, multi, titleFormatter)',
                ],

                listeners: {
                    'Menu.opened-changed': '_menuOpenedChangedListener',
                },

                //// Lifecycle callbacks. //////////////////////////////////////

                ready() {
                    // We need to monitor the Light DOM under Shady DOMs
                    // to scope the styles of the nodes generated by the iron-list.
                    this.scopeSubtree(this, true)

                    this._setFilteredItems = Lodash.debounce(this._setFilteredItems, 400)
                },

                attached() {
                    const contentSlot  = Polymer.dom(this.$.ContentSlot)
                    const slotObserver = contentSlot.observeNodes(this._slotObserver.bind(this))

                    this._slotObserverId = slotObserver
                },

                detached() {
                    const contentSlot = Polymer.dom(this.$.ContentSlot)

                    contentSlot.unobserveNodes(this._slotObserverId)
                },

                //// Computers. ////////////////////////////////////////////////

                //// Observers. ////////////////////////////////////////////////

                _setFilteredItems(items, searchString) {
                    const search      = searchString.trim()
                    let selectedItems = Lodash.clone(this.selectedItems)

                    if (search === '') {
                        // Optimization
                        this.filteredItems = items
                        this._restoreSelectedItems(selectedItems)

                        return
                    }

                    const searchLc      = search.toLowerCase()
                    const filteredItems = items.filter(item => this._filterItem(item, searchLc), this)

                    if (! Lodash.isNil(selectedItems)) {
                        selectedItems = Array.isArray(selectedItems) ? selectedItems : [selectedItems]
                    }

                    this.filteredItems = Lodash.unionWith(filteredItems, selectedItems, Lodash.isEqual)

                    this._restoreSelectedItems(selectedItems)
                },

                _setItemsSize(items, itemHeight, maxHeight) {
                    if (Lodash.some(arguments, Lodash.isNil)) {
                        return
                    }

                    if (itemHeight === 0) {
                        return
                    }

                    const itemsSize   = items.length
                    const itemsHeight = itemHeight * itemsSize
                    const height      = Math.min(itemsHeight, maxHeight)
                    // const width       = Math.min(itemWidth,   maxWidth)
                    const list        = this.$.List

                    list.style.height = height + 'px'
                },

                _selectAuto(items, filteredItems) {
                    if (Lodash.some(arguments, Lodash.isNil)) {
                        return
                    }

                    if (this.manualSelect === true) {
                        return
                    }

                    if (items.length !== 1 || filteredItems.length !== 1) {
                        return
                    }

                    const list = this.$.List

                    list.selectItem(0)
                },

                _select(items, selected) {
                    const list = this.$.List

                    if (! items) {
                        return
                    }

                    if (! list.items) {
                        // This should not happen.
                        return
                    }

                    if (this.multi) {
                        // We are handling a multi selection.

                        // 1) We begin a downward propagation.
                        this._downwardSelection = true

                        const selectedItems = selected || [] // 'selected' could be null or undefined.

                        // 2)
                        // We deselect on the iron-list every item not selected
                        // in the graphene-dropdown-menu.
                        list.items.forEach(it => {
                            if (! selectedItems.includes(it)) {
                                // The iron-list item is not in the list of the
                                // selected items. We must deselect it.
                                list.deselectItem(it)
                            }
                        })
                        // 3)
                        // We select on the iron-list every item selected in
                        // the graphene-dropdown-menu.
                        selectedItems.forEach(it => {
                            if (! list.items.includes(it)) {
                                console.debug(this.localName, 'has not the item:', it, 'in', list.items, this)
                                return
                            }

                            list.selectItem(it)
                        })

                        // 4) We end the downward propagation.
                        this._downwardSelection = false

                        return
                    }

                    if (Lodash.isNil(selected)) {
                        // We are handing a single selection dropdown and we
                        // have to deselect the item of the iron-list.
                        this._downwardSelection = true
                        list.clearSelection()
                        this._downwardSelection = false

                        return
                    }

                    if (! list.items.includes(selected)) {
                        console.debug(this.localName, 'has not the item:', selected, 'in', list.items, this)
                        return
                    }

                    // We are handling a single selection dropdown and we have
                    // to select on the iron-list the selected item of the
                    // graphene-dropdown-menu.
                    this._downwardSelection = true
                    list.selectItem(selected)
                    this._downwardSelection = false
                },

                _setTitle(selectedItemsChange, multi, titleFormatter) {
                    // Don't do this because selectedItemsChange is null when
                    // multi is false and the user deselects the item.
                    // if (Lodash.some(arguments, Lodash.isNil)) {
                    //     return
                    // }

                    const selectedItems = multi
                        ? this.selectedItems
                        : this.selectedItem
                    const title = titleFormatter(selectedItems || { name: '' })
                    const target = this.$.Content

                    if (title) {
                        const itemNode = this.create('span', { label: title })

                        this.fire('iron-select', { item: itemNode }, { node: target })
                    }
                    else {
                        this.fire('iron-deselect', undefined, { node: target })
                    }

                    return this
                },

                //// Listeners. ////////////////////////////////////////////////

                _menuOpenedChangedListener(event, detail) {
                    const node            = Polymer.dom(event).rootTarget    // Who fired the event.
                    const isPaperDropdown = node.localName === 'paper-dropdown-menu'

                    if (! isPaperDropdown) {
                        return
                    }

                    const dropdownMenu = this.$.Menu
                    const menuButton   = dropdownMenu.$$('paper-menu-button')
                    const dropdown     = menuButton.$$('iron-dropdown')

                    // iron-list are rendered only when visible, but the
                    // iron-dropdown imposes display:none on the content (the
                    // iron-list) resulting in an iron-list not rendered until
                    // the iron-dropdown becomes visible, but at this point the
                    // iron-dropdown has already computed its content
                    // (iron-list) size which is zero.  We give a bit of time
                    // to the iron-dropdown to display the iron-list and to the
                    // iron-list to generate its content and, after that, we
                    // inform the paper-dropdown-menu to recompute its content
                    // size.
                    this.async(() => dropdown.notifyResize, 400)

                    const isOpenChange = detail.value
                    const hasFilter    = this.filter !== undefined

                    if (! isOpenChange || ! hasFilter) {
                        return
                    }

                    function focusFilter() {
                        const input = this.$.Filter.inputElement
                        input.focus()
                    }

                    // We want to focus the filter input, with a delay due to the
                    // dropdown content opening animation
                    this.async(focusFilter.bind(this), 400)
                },

                _stopEvent(event) {
                    // Internal events must not escaped from the component.
                    event.stopPropagation()
                },

                _selectedItemsChanged(event, detail) {
                    this._stopEvent(event)

                    if (this._downwardSelection) {
                        // Downward selection in progress.
                        return
                    }

                    const source = Polymer.dom(event).rootTarget
                    const target = Polymer.dom(event).localTarget

                    if (source !== target) {
                        // Event can be fired by an internal component
                        // (ex. paper-dropdown-menu, iron-list and array-selector).
                        return
                    }

                    // This function can be executed for 5 reasons.
                    // When this.multi is true, for a
                    // - '.splices' notification (detail.path includes '.splices')
                    // - '.length' notification (detail.path includes '.length')
                    // - <iron-list>.clearSelection() (detail.value === [])
                    // When this.multi is false, for
                    // - deselect (detail.value === null)
                    // - select (detail.value is the item)

                    const isLengthChange = detail.path && detail.path.includes('.length')
                    // const isSpliceChange = detail.path && detail.path.includes('.splices')

                    if (isLengthChange) {
                        // The '.length' change notification arrives right after
                        // we '.splices' notification. We skip it because we
                        // we don't need to re-debounce the set.
                        return
                    }

                    const prop = this.multi
                        ? 'selectedItems'
                        : 'selectedItem'

                    const value = this.multi
                        // We shallow clone the array because Polymer mutates in place.
                        ? target.selectedItems.slice()
                        : detail.value

                    const debounceTime = 50
                    const debounceId = '_selectedItemsChanged'
                    const debounceFn = () => this.set(prop, value)

                    this.debounce(debounceId, debounceFn, debounceTime)
                },

                //// Public APIs. //////////////////////////////////////////////

                reset() {
                    const list = this.$.List

                    list.clearSelection()
                },

                validate() {
                    const menu = this.$.Menu
                    const valid = menu.validate()

                    return valid
                },

                //// Internal APIs. ////////////////////////////////////////////

                _slotObserver(info) {
                    // const children = this.getEffectiveChildren()
                    const newNodes = info.addedNodes

                    // Remember, template tags have height and width of 0.
                    const items = newNodes.filter(node => node.nodeType === Element.ELEMENT_NODE)

                    if (items.length === 0) {
                        return
                    }
                    const size = { height: 0, width: 0 }

                    items.forEach(item => {
                        size.height = Math.max(item.offsetHeight, size.height, this.itemHeight || 0)
                    })

                    this.itemHeight = size.height
                },

                _filterItem(item, search) {
                    let itemText = ''
                    const fields = this.filterFields

                    function stringify(field) {
                        // Prevents from searching into non existing fields
                        if (item[field] === undefined) {
                            return
                        }

                        itemText += item[field].toLowerCase()
                    }

                    fields.forEach(stringify)

                    const index = itemText.indexOf(search)
                    return index > -1
                },

                _restoreSelectedItems(selected) {
                    if (Lodash.some(arguments, Lodash.isNil) || this.filteredItems.length === 0 || ! this.filter) {
                        return
                    }

                    const list         = this.$.List
                    const dropdownMenu = this.$.Menu
                    const menuButton   = dropdownMenu.$$('paper-menu-button')

                    function selectItem(item) {
                        const index = Lodash(this.filteredItems).findIndex(item)

                        if (index < 0) {
                            return
                        }

                        const isMulti = this.$.List.multiSelection

                        if (isMulti) {
                            list.selectItem(index)
                        }
                        else {
                            this.configurePaperMenuButton(menuButton, false)
                            list.selectItem(index)
                            this.configurePaperMenuButton(menuButton, true)
                        }
                    }

                    const selectedItems = Lodash.flatten([ selected ])

                    selectedItems.forEach(selectItem, this)
                },
            })
        })()
        // ]]>
    </script>
</dom-module>
